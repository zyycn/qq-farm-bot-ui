# 项目重构指南：后端架构升级 (core Refactoring)

## 角色设定
你是一名资深后端架构师，精通 Node.js、TypeScript 及 NestJS 生态。你的任务是将当前基于 CommonJS/Express 的后端代码重构为基于 **NestJS** 的现代化、模块化架构，并与前端技术栈（Vue 3 + TS）保持一致性与协作性。

## 技术栈规范 (core)
- **核心框架**: [NestJS](https://nestjs.com/) (模块化、依赖注入、TypeScript 优先)
- **语言**: TypeScript (严格模式)
- **包管理**: pnpm (Monorepo 风格管理或独立目录均可，建议与前端保持一致)
- **运行时**: Node.js LTS (v18/v20+)
- **数据库/ORM**: **JSON 文件** (保持原有 `accounts.json` / `store.json` 存储方式，可封装为 Service 进行类型安全读写)
- **接口协议**:
  - **REST API**: 用于前端管理面板的数据交互 (基于 NestJS Controllers)
  - **WebSocket (Gateway)**: 用于前端实时日志、状态同步 (基于 `@nestjs/websockets`)
  - **Protobuf**: 用于与 QQ 农场服务器通信 (复用现有 `.proto` 文件)
- **任务调度**: `@nestjs/schedule` (替换原有的 `setInterval` 轮询)
- **配置管理**: `@nestjs/config` (环境变量与配置文件)
- **日志系统**: `winston` 或 `pino` (结构化日志)
- **代码规范**: @antfu/eslint-config (与前端统一)

## 项目结构说明 (Proposed Structure)
建议在根目录下创建 `core/` 目录，与 `web/` 并列。

```text
core/
├── src/
│   ├── app.module.ts           # 根模块
│   ├── main.ts                 # 入口文件
│   ├── common/                 # 通用模块 (Filters, Guards, Interceptors)
│   ├── config/                 # 配置定义
│   ├── services/               # 通用服务
│   │   └── json-db.service.ts  # JSON 文件读写服务
│   ├── modules/                # 业务模块
│   │   ├── core/               # 核心底层 (Protobuf, QQ Farm Socket Client)
│   │   │   ├── network.service.ts  # 负责与农场服务器的 TCP/WS 连接
│   │   │   └── proto.service.ts    # 负责 Protobuf 编解码
│   │   ├── account/            # 账号管理 (CRUD, 登录逻辑)
│   │   ├── farm/               # 农场业务 (种植, 收获, 土地管理)
│   │   ├── friend/             # 好友业务 (偷菜, 帮助)
│   │   ├── task/               # 任务与活动
│   │   ├── analytics/          # 数据分析
│   │   └── websocket/          # 前端实时通讯 Gateway
│   └── utils/                  # 工具函数
├── test/                       # E2E 测试
├── nest-cli.json
├── package.json
└── tsconfig.json
```

## 核心重构策略

### 1. 状态管理迁移 (State Management)
- **现状**: 使用 `src/store.js` 进行文件读写。
- **重构**:
  - 封装 **JsonDbService** 进行文件操作，提供类型安全的读写接口 (如 `getAccounts()`, `saveAccount()`)。
  - 使用 **NestJS Services** (单例) 在内存中维护运行时状态（如当前的 Socket 连接、登录 Token、缓存的游戏数据）。

### 2. 进程模型调整 (Process Model)
- **现状**: `client.js` 使用 `child_process.fork` 启动 Worker 进程。
- **重构**:
  - 方案 A (推荐): **单进程多实例模式**。利用 Node.js 的异步非阻塞特性，在同一个 NestJS 实例中管理多个账号的连接（每个账号对应一个 `FarmClient` 实例）。这样可以极大降低内存占用，且便于集中管理和日志聚合。
  - 方案 B: 保持多进程，但使用 NestJS Microservices (Redis/TCP) 进行进程间通信 (IPC)。(复杂度较高，仅在单进程性能瓶颈时考虑)。
  - **决策**: 优先采用 **方案 A**。

### 3. 网络层重写 (Network Layer)
- **现状**: `src/network.js` 耦合了 WebSocket 连接、心跳、Protobuf 编码和部分业务逻辑。
- **重构**:
  - 拆分为 `NetworkClient` 类：专门负责 WebSocket 连接维护、重连机制、心跳包。
  - 拆分为 `ProtocolService`：专门负责 Protobuf 的 encode/decode。
  - 使用 `RxJS` 处理异步消息流（可选，NestJS 风格）。

### 4. 任务调度 (Scheduling)
- **现状**: 使用 `setTimeout` / `setInterval` 分散在各处。
- **重构**:
  - 使用 `@nestjs/schedule` 统一管理定时任务（如：每分钟检查一次成熟、每小时更新好友列表）。
  - 实现动态任务调度（根据每个账号的配置启动/停止任务）。

### 4. 接口兼容性 (API Compatibility)
- **严格遵循旧版接口**: 必须确保 REST API 的路径、请求参数、响应结构与 `src/admin.js` 完全一致。
- **前端零修改**: 后端重构不应导致前端 `web/src/api` 下的代码变更。
- **关键接口列表**:
  - `/api/login` (POST)
  - `/api/status` (GET)
  - `/api/automation` (POST)
  - `/api/lands` (GET)
  - `/api/friends` (GET)
  - `/api/friend/:gid/lands` (GET)
  - `/api/friend/:gid/op` (POST)
  - `/api/seeds` (GET)
  - `/api/logs` (GET)
  - `/api/qr/create` (POST)
  - `/api/qr/check` (POST)
  - `/api/accounts` (GET/POST/DELETE)
  - `/api/account/remark` (POST)

## 开发流程
1.  **环境搭建**: 初始化 NestJS 项目，配置 ESLint。
2.  **数据层迁移**: 封装 `JsonDbService`，实现对 `accounts.json` 和 `store.json` 的读写。
3.  **核心库移植**:
    - 将 `proto/` 目录下的 `.proto` 文件集成到 NestJS。
    - 移植 `protobufjs` 编解码逻辑。
    - 实现 `FarmNetworkService`，能够连通 QQ 农场服务器。
4.  **业务模块实现**:
    - **AuthModule**: 实现扫码登录流程 (移植 `src/qrlogin.js`)。
    - **FarmModule**: 移植农场操作 (harvest, plant 等)。
    - **FriendModule**: 移植好友操作。
5.  **API 开发**: 使用 Controller 暴露 REST API，供前端调用。
6.  **对接联调**: 确保前端能正确展示数据并控制后端。

## 完成情况

### 第一阶段：基础设施 (Infrastructure)
- [ ] **项目初始化**: 创建 `core` 目录，配置 NestJS + TypeScript + pnpm。
- [ ] **代码规范**: 配置 ESLint (@antfu/eslint-config) 与 Prettier。
- [ ] **数据存储**: 实现 `JsonDbService` (JSON 读写工具)，确保对 `accounts.json` 的并发读写安全。
- [ ] **日志系统**: 集成 Winston/Pino，实现文件与控制台日志输出。

### 第二阶段：核心连接 (Core Connectivity)
- [ ] **Protobuf 集成**: 加载 `.proto` 文件，实现强类型的编解码服务。
- [ ] **网络客户端**: 实现 `FarmConnection` 类，支持 WebSocket 连接、自动重连、心跳保活。
- [ ] **登录模块**: 移植扫码登录逻辑，实现 Session 获取与持久化。

### 第三阶段：业务功能 (Business Logic)
- [ ] **账号管理 API**: CRUD 账号，支持从 JSON 文件加载账号并自动登录。
- [ ] **农场信息同步**: 实现 `getLands`, `getUserInfo` 等基础信息获取。
- [ ] **自动化引擎**: 实现基于队列或定时器的自动化任务 (Harvest, Plant, Water)。
- [ ] **好友互动**: 实现好友列表获取、偷菜、帮助等功能。

### 第四阶段：API 与前端对接 (API & Integration)
- [ ] **REST API**: 实现所有前端需要的 HTTP 接口 (参考 `src/admin.js`)，确保与前端现有调用完全兼容。
- [ ] **WebSocket Gateway**: 实现实时日志推送到前端 Dashboard，确保消息格式与旧版一致。
- [ ] **系统集成**: 替换旧版 `client.js`，实现一键启动前后端。

## 注意事项
- 保持 `proto` 文件的原样引用，不要修改协议定义。
- 优先复用 `src/` 下现有的业务逻辑代码（如经验计算、种子数据），将其改写为 TS 类/函数。
- 确保所有敏感数据（Token, Session）在日志中脱敏。
